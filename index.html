<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR â€” Intro â†’ Menu â†’ Exercise</title>

  <style>
    :root { --z-ui:5; --z-menu:6; --z-debug:20 }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial,sans-serif}
    canvas.webgl{position:fixed;inset:0;width:100vw;height:100vh;background:#000}

    #startLayer{position:fixed;inset:0;display:grid;place-items:center;z-index:var(--z-ui);background:#000}
    .btn{padding:14px 18px;border:0;border-radius:14px;cursor:pointer;background:#fff;color:#111;font-weight:700;box-shadow:0 8px 28px rgba(0,0,0,.25);transition:transform 0.2s ease}
    .btn:hover{transform:scale(1.05)}
    .btn:active{transform:scale(0.95)}
    #btnUnmute{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);z-index:var(--z-ui);display:none}

    #menu{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-menu);background:rgba(0,0,0,0.8)}
    .menu-inner{display:flex;flex-direction:column;gap:16px;padding:20px;border-radius:20px;background:rgba(255,255,255,0.1);backdrop-filter:blur(10px)}

    #debug{position:fixed;left:10px;top:10px;z-index:var(--z-debug);color:#0f0;background:rgba(0,0,0,.7);
           padding:8px 12px;border-radius:8px;font:12px/1.4 monospace;white-space:pre-wrap;max-width:90vw;
           border:1px solid rgba(0,255,0,0.3)}
    
    #instructions{position:fixed;bottom:20px;left:20px;right:20px;z-index:var(--z-ui);
                  color:#fff;text-align:center;background:rgba(0,0,0,0.6);
                  padding:12px;border-radius:12px;font-size:14px;display:none}
  </style>

  <!-- THREE + Zappar -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js" defer></script>
  <script src="https://unpkg.com/@zappar/zappar-threejs@2.5.2/umd/zappar-threejs.js" defer></script>

  <script>
    // Clear any existing service workers
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations?.().then(rs => rs.forEach(r => r.unregister()));
    }
    
    // Wait for dependencies to load
    window.__depsReady = new Promise(res => addEventListener('load', () => {
      res({ THREE: window.THREE, ZapparThree: window.ZapparThree });
    }, { once:true }));
  </script>
</head>
<body>
  <div id="debug">DEBUG: Initializing...</div>

  <!-- START button layer -->
  <div id="startLayer">
    <button id="btnStart" class="btn">START EXPERIENCE</button>
  </div>

  <!-- Loading Screen -->
  <div id="loadingScreen">
    <div class="loading-spinner"></div>
    <h2 style="color:#fff;margin:0;">Starting AR Experience...</h2>
    <p style="color:#ccc;margin:0;">Please allow camera access when prompted</p>
  </div>

  <!-- Countdown Overlay -->
  <div id="countdownOverlay">
    <div class="countdown-number" id="countdownNumber">3</div>
    <p style="color:#fff;font-size:18px;margin:0;">Get ready for AR content...</p>
  </div>

  <!-- Permission Error Screen -->
  <div id="permissionError">
    <h2 style="color:#fff;margin-bottom:20px;">Camera Access Required</h2>
    <p style="color:#ccc;margin-bottom:30px;">This AR experience needs camera access to work properly.</p>
    <button id="btnRetry" class="btn">Try Again</button>
  </div>
  
  <button id="btnUnmute" class="btn">ðŸ”Š Enable Audio</button>
  
  <div id="menu">
    <div class="menu-inner">
      <h2 style="color:#fff;margin:0 0 10px 0;text-align:center;">Select Experience</h2>
      <button class="btn" id="btnExercise">Start Exercise</button>
      <button class="btn" id="btnRestart">Restart Intro</button>
    </div>
  </div>

  <div id="instructions">Tap anywhere to place the AR content in your space</div>

  <!-- Hidden video elements -->
  <video id="vidIntro" playsinline preload="auto" style="display:none" crossorigin="anonymous"></video>
  <video id="vidExercise" playsinline preload="auto" loop style="display:none" crossorigin="anonymous"></video>

  <script>
    /********** Configuration **********/
    const INTRO_WEBM_URL     = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
    const INTRO_MP4_URL      = "";
    const EXERCISE_WEBM_URL  = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";
    const EXERCISE_MP4_URL   = "";

    // Debug logger
    const dbg = (message) => {
      console.log('DEBUG:', message);
      document.getElementById('debug').textContent = 'DEBUG: ' + message;
    };

    // DOM elements
    const vIntro = document.getElementById('vidIntro');
    const vExercise = document.getElementById('vidExercise');
    const loadingScreen = document.getElementById('loadingScreen');
    const permissionError = document.getElementById('permissionError');
    const countdownOverlay = document.getElementById('countdownOverlay');
    const countdownNumber = document.getElementById('countdownNumber');
    const btnRetry = document.getElementById('btnRetry');
    const btnUnmute = document.getElementById('btnUnmute');
    const menu = document.getElementById('menu');

    // Set video sources with proper codec support
    function setupVideoSources(videoElement, webmUrl, mp4Url = "") {
      videoElement.innerHTML = "";
      if (webmUrl) {
        const webmSource = document.createElement('source');
        webmSource.src = webmUrl;
        webmSource.type = 'video/webm; codecs="vp8,opus"';
        videoElement.appendChild(webmSource);
      }
      if (mp4Url) {
        const mp4Source = document.createElement('source');
        mp4Source.src = mp4Url;
        mp4Source.type = 'video/mp4';
        videoElement.appendChild(mp4Source);
      }
      
      // Optimize video settings for better quality
      videoElement.setAttribute('webkit-playsinline', 'true');
      videoElement.setAttribute('playsinline', 'true');
      videoElement.preload = 'auto';
      
      videoElement.load();
    }

    // Custom countdown function
    async function showCountdown(seconds = 3) {
      return new Promise((resolve) => {
        countdownOverlay.style.display = 'flex';
        let count = seconds;
        countdownNumber.textContent = count;
        
        const countInterval = setInterval(() => {
          count--;
          if (count > 0) {
            countdownNumber.textContent = count;
            // Trigger animation by removing and re-adding class
            countdownNumber.style.animation = 'none';
            setTimeout(() => {
              countdownNumber.style.animation = 'pulse 1s ease-in-out';
            }, 10);
          } else {
            countdownNumber.textContent = 'GO!';
            setTimeout(() => {
              clearInterval(countInterval);
              countdownOverlay.style.display = 'none';
              resolve();
            }, 1000);
          }
        }, 1000);
      });
    }

    /********** AR Engine **********/
    let THREE, ZapparThree, renderer, camera, scene, tracker, anchor, plane;
    let hasPlacedContent = false;
    let introTexture, exerciseTexture, currentVideo;

    // Request camera permissions
    async function requestCameraAccess() {
      try {
        // Custom camera permission request
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          } 
        });
        
        // Stop the stream as Zappar will handle it
        stream.getTracks().forEach(track => track.stop());
        
        const permitted = await ZapparThree.permissionRequest();
        if (!permitted) {
          throw new Error('Zappar permission denied');
        }
        
        camera?.start();
        dbg('Camera access granted and started');
        return true;
      } catch (error) {
        dbg('Camera permission failed: ' + error.message);
        throw error;
      }
    }

    // Create video texture
    function createVideoTexture(videoElement) {
      const texture = new THREE.VideoTexture(videoElement);
      texture.colorSpace = THREE.SRGBColorSpace;
      texture.flipY = false;
      
      // Optimize texture settings for better quality
      texture.minFilter = THREE.LinearFilter;
      texture.magFilter = THREE.LinearFilter;
      texture.format = THREE.RGBFormat;
      texture.generateMipmaps = false;
      
      return texture;
    }

    // Fit plane to video aspect ratio and position it upright
    function adjustPlaneToVideo(videoElement) {
      const width = videoElement.videoWidth || 1280;
      const height = videoElement.videoHeight || 720;
      
      // Calculate optimal size based on closer position
      const displayHeight = 0.8; // Slightly smaller but closer for better quality
      const displayWidth = displayHeight * (width / height);
      
      // Update geometry with higher resolution
      plane.geometry.dispose();
      plane.geometry = new THREE.PlaneGeometry(displayWidth, displayHeight, 32, 32);
      
      // Position at optimized location
      plane.position.set(AR_POSITION.x, AR_POSITION.y, AR_POSITION.z);
      plane.rotation.set(0, 0, 0);
      
      dbg(`Optimized AR plane: ${displayWidth.toFixed(2)}x${displayHeight}m at ${AR_POSITION.z}m distance`);
    }

    // Initialize AR system with quality optimizations
    async function initializeAR() {
      try {
        // Wait for dependencies
        ({ THREE, ZapparThree } = await window.__depsReady);
        
        if (!THREE || !ZapparThree) {
          throw new Error('Failed to load dependencies');
        }

        if (ZapparThree.browserIncompatible()) {
          throw new Error('Browser not compatible');
        }

        // Setup high-quality WebGL renderer
        renderer = new THREE.WebGLRenderer({ 
          antialias: true, 
          alpha: false, 
          powerPreference: 'high-performance',
          precision: 'highp'
        });
        
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Limit pixel ratio for performance
        renderer.domElement.classList.add('webgl');
        document.body.appendChild(renderer.domElement);

        window.addEventListener('resize', () => {
          renderer.setSize(window.innerWidth, window.innerHeight);
        });

        ZapparThree.glContextSet(renderer.getContext());

        // Setup camera with quality settings
        camera = new ZapparThree.Camera({ 
          userFacing: false,
          rearCameraSource: 'best' // Request best quality rear camera
        });
        scene = new THREE.Scene();
        scene.background = camera.backgroundTexture;

        // Setup instant world tracking
        tracker = new ZapparThree.InstantWorldTracker();
        anchor = new ZapparThree.InstantWorldAnchorGroup(camera, tracker);
        scene.add(anchor);

        // Create optimized display plane
        plane = new THREE.Mesh(
          new THREE.PlaneGeometry(1, 1, 16, 16),
          new THREE.MeshBasicMaterial({ 
            transparent: true, 
            side: THREE.DoubleSide,
            alphaTest: 0.1
          })
        );
        anchor.add(plane);

        // Start render loop
        renderer.setAnimationLoop(() => {
          if (!hasPlacedContent) {
            // Before placement, position content 2 meters in front
            tracker.setAnchorPoseFromCameraOffset(0, 0, -2);
          }
          
          // Keep plane upright and facing camera
          makePlaneUpright();
          
          // Update and render
          camera.updateFrame(renderer);
          renderer.render(scene, camera);
        });

        // Handle app visibility changes
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            try { camera.start(); } catch (e) { console.warn('Camera restart failed:', e); }
          } else {
            try { camera.pause(); } catch (e) { console.warn('Camera pause failed:', e); }
          }
        });

        arInitialized = true;
        dbg('High-quality AR system initialized');
        
      } catch (error) {
        console.error('AR initialization failed:', error);
        dbg('AR initialization failed: ' + error.message);
        throw error;
      }
    }

    // Play video with audio handling
    async function playVideoWithAudio(videoElement) {
      try {
        // Ensure video is ready
        if (videoElement.readyState < 2) {
          await new Promise(resolve => {
            videoElement.addEventListener('canplay', resolve, { once: true });
          });
        }
        
        videoElement.muted = false;
        await videoElement.play();
        btnUnmute.style.display = 'none';
        dbg('Video playing with audio');
      } catch (error) {
        // Fallback to muted playback
        videoElement.muted = true;
        try {
          await videoElement.play();
          btnUnmute.style.display = 'inline-block';
          dbg('Video playing muted - click unmute button');
        } catch (playError) {
          dbg('Failed to play video: ' + playError.message);
        }
      }
    }

    // Start AR experience
    btnStart.addEventListener('click', async () => {
      try {
        dbg('Starting enhanced AR experience...');
        
        await requestCameraAccess();
        
        // Setup high-quality video sources
        setupVideoSources(vIntro, INTRO_WEBM_URL, INTRO_MP4_URL);
        setupVideoSources(vExercise, EXERCISE_WEBM_URL, EXERCISE_MP4_URL);

        // Create textures
        introTexture = introTexture || createVideoTexture(vIntro);
        exerciseTexture = exerciseTexture || createVideoTexture(vExercise);

        // Start with intro video
        currentVideo = vIntro;
        plane.material.map = introTexture;
        hasPlacedContent = false;

        if (vIntro.readyState >= 1) {
          adjustPlaneToVideo(vIntro);
        } else {
          vIntro.addEventListener('loadedmetadata', () => adjustPlaneToVideo(vIntro), { once: true });
        }

        // Show countdown before starting
        hideAllScreens();
        await showCountdown(3);
        
        await playVideoWithAudio(vIntro);

        // Setup placement handler
        const handlePlacement = () => {
          hasPlacedContent = true;
          instructions.style.display = 'none';
          window.removeEventListener('pointerdown', handlePlacement);
          dbg('AR content placed in space');
        };
        
        window.addEventListener('pointerdown', handlePlacement, { once: true, passive: true });

        // Show instructions and hide start screen
        instructions.style.display = 'block';
        startLayer.style.display = 'none';
        
        dbg('Intro video ready - tap to place in AR space');

        // Handle intro video end
        vIntro.onended = () => {
          menu.style.display = 'flex';
          instructions.style.display = 'none';
          dbg('Intro completed - showing menu');
        };

      } catch (error) {
        console.error('Failed to start AR experience:', error);
        dbg('Failed to start: ' + error.message);
        alert('Failed to start AR experience. Please ensure you have granted camera permissions and are using a supported browser.');
      }
    });

    // Enable audio button
    btnUnmute.addEventListener('click', async () => {
      if (currentVideo) {
        try {
          currentVideo.muted = false;
          await currentVideo.play();
          btnUnmute.style.display = 'none';
          dbg('Audio enabled');
        } catch (error) {
          dbg('Failed to enable audio: ' + error.message);
        }
      }
    });

    // Exercise with permission re-request
    document.getElementById('btnExercise').addEventListener('click', async () => {
      try {
        menu.style.display = 'none';
        dbg('Starting exercise with fresh permission...');

        // Re-request camera permission for exercise
        try {
          await requestCameraAccess();
        } catch (e) {
          dbg('Camera permission needed for exercise');
          showPermissionError();
          return;
        }

        if (currentVideo) currentVideo.pause();

        currentVideo = vExercise;
        plane.material.map = exerciseTexture;
        hasPlacedContent = false;

        if (vExercise.readyState >= 1) {
          adjustPlaneToVideo(vExercise);
        } else {
          vExercise.addEventListener('loadedmetadata', () => adjustPlaneToVideo(vExercise), { once: true });
        }

        // Show countdown before exercise
        await showCountdown(3);
        
        vExercise.currentTime = 0;
        await playVideoWithAudio(vExercise);
        
        dbg('Exercise playing in high-quality AR');

      } catch (error) {
        console.error('Failed to start exercise:', error);
        dbg('Failed to start exercise: ' + error.message);
      }
    });

    // Restart intro button
    document.getElementById('btnRestart').addEventListener('click', async () => {
      try {
        menu.style.display = 'none';
        dbg('Restarting intro...');

        if (currentVideo) currentVideo.pause();

        // Switch back to intro
        currentVideo = vIntro;
        plane.material.map = introTexture;

        await showCountdown(2);
        
        vIntro.currentTime = 0;
        await playVideoWithAudio(vIntro);

        dbg('Intro restarted in high quality');

      } catch (error) {
        console.error('Failed to restart intro:', error);
        dbg('Failed to restart: ' + error.message);
      }
    });

    // Initialize everything
    window.addEventListener('load', async () => {
      try {
        await initializeAR();
        await startARExperience();
      } catch (error) {
        console.error('Failed to initialize:', error);
        dbg('Initialization failed - check console');
        showPermissionError();
      }
    });

    // Hide Zappar branding with additional methods
    setTimeout(() => {
      const zapparElements = document.querySelectorAll('[class*="zappar"], [id*="zappar"]');
      zapparElements.forEach(el => el.style.display = 'none');
    }, 1000);
  </script>
</body>
</html>
