<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR ‚Äî Auto AR Experience</title>

  <style>
    :root { --z-ui:5; --z-menu:6; --z-debug:20; --z-countdown:25 }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial,sans-serif}
    canvas.webgl{position:fixed;inset:0;width:100vw;height:100vh;background:#000}

    #startLayer{position:fixed;inset:0;display:grid;place-items:center;z-index:var(--z-ui);background:#000}
    .btn{padding:14px 18px;border:0;border-radius:14px;cursor:pointer;background:#fff;color:#111;font-weight:700;box-shadow:0 8px 28px rgba(0,0,0,.25);transition:transform 0.2s ease}
    .btn:hover{transform:scale(1.05)}
    .btn:active{transform:scale(0.95)}
    #btnUnmute{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);z-index:var(--z-ui);display:none}

    #menu{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-menu);background:rgba(0,0,0,0.8)}
    .menu-inner{display:flex;flex-direction:column;gap:16px;padding:20px;border-radius:20px;background:rgba(255,255,255,0.1);backdrop-filter:blur(10px)}

    #debug{position:fixed;left:10px;top:10px;z-index:var(--z-debug);color:#0f0;background:rgba(0,0,0,.7);
           padding:8px 12px;border-radius:8px;font:12px/1.4 monospace;white-space:pre-wrap;max-width:90vw;
           border:1px solid rgba(0,255,0,0.3)}
    
    #loadingScreen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-ui);
                   background:#000;flex-direction:column;gap:20px}
    
    .loading-spinner{width:50px;height:50px;border:4px solid rgba(255,255,255,0.3);border-top:4px solid #fff;
                     border-radius:50%;animation:spin 1s linear infinite}
    
    @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
    
    #permissionError{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-ui);
                     background:#000;flex-direction:column;gap:20px;text-align:center;padding:20px}

    #countdownOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-countdown);
                      background:rgba(0,0,0,0.8);flex-direction:column;gap:20px}
    
    .countdown-number{font-size:120px;color:#fff;font-weight:bold;text-shadow:0 0 20px rgba(255,255,255,0.5);
                      animation:pulse 1s ease-in-out}
    
    @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.1)} 100%{transform:scale(1)} }

    /* ‚ö†Ô∏è –¢—É—Ä—à–∏–ª—Ç—ã–Ω “Ø–µ—ç—Ä Zappar UI-–≥ –ù–£–£–•–ì“Æ–ô ‚Äî popup, –∞–ª–¥–∞–∞ —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞
    .zappar-permission-request-overlay,
    .zappar-permission-denied-ui,
    .zappar-browser-incompatible-ui,
    div[style*="zappar"]{display:none !important}
    */
  </style>

  <!-- THREE + Zappar -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js" defer></script>
  <script src="https://unpkg.com/@zappar/zappar-threejs@2.5.2/umd/zappar-threejs.js" defer></script>

  <script>
    // Clear any existing service workers
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations?.().then(rs => rs.forEach(r => r.unregister()));
    }
    
    // Wait for dependencies to load
    window.__depsReady = new Promise(res => addEventListener('load', () => {
      res({ THREE: window.THREE, ZapparThree: window.ZapparThree });
    }, { once:true }));
  </script>
</head>
<body>
  <div id="debug">DEBUG: Ready‚Ä¶</div>

  <!-- START button layer -->
  <div id="startLayer">
    <button id="btnStart" class="btn">START EXPERIENCE</button>
  </div>

  <!-- Loading Screen -->
  <div id="loadingScreen">
    <div class="loading-spinner"></div>
    <h2 style="color:#fff;margin:0;">Starting AR Experience...</h2>
    <p style="color:#ccc;margin:0;">Please allow camera access when prompted</p>
  </div>

  <!-- Countdown Overlay -->
  <div id="countdownOverlay">
    <div class="countdown-number" id="countdownNumber">3</div>
    <p style="color:#fff;font-size:18px;margin:0;">Get ready for AR content...</p>
  </div>

  <!-- Permission Error Screen -->
  <div id="permissionError">
    <h2 style="color:#fff;margin-bottom:20px;">Camera Access Required</h2>
    <p style="color:#ccc;margin-bottom:30px;">This AR experience needs camera access to work properly.</p>
    <button id="btnRetry" class="btn">Try Again</button>
  </div>
  
  <button id="btnUnmute" class="btn">üîä Enable Audio</button>
  
  <div id="menu">
    <div class="menu-inner">
      <h2 style="color:#fff;margin:0 0 10px 0;text-align:center;">Select Experience</h2>
      <button class="btn" id="btnExercise">Start Exercise</button>
      <button class="btn" id="btnRestart">Restart Intro</button>
    </div>
  </div>

  <!-- Hidden video elements -->
  <video id="vidIntro" playsinline preload="auto" style="display:none" crossorigin="anonymous"></video>
  <video id="vidExercise" playsinline preload="auto" loop style="display:none" crossorigin="anonymous"></video>

  <script>
    /********** Configuration **********/
    const INTRO_WEBM_URL     = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
    const INTRO_MP4_URL      = "";
    const EXERCISE_WEBM_URL  = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";
    const EXERCISE_MP4_URL   = "";

    const AR_POSITION = { x: 0, y: 0, z: -1.5 };

    const dbg = (m) => { console.log('DEBUG:', m); document.getElementById('debug').textContent = 'DEBUG: ' + m; };

    // DOM
    const vIntro = document.getElementById('vidIntro');
    const vExercise = document.getElementById('vidExercise');
    const loadingScreen = document.getElementById('loadingScreen');
    const permissionError = document.getElementById('permissionError');
    const countdownOverlay = document.getElementById('countdownOverlay');
    const countdownNumber = document.getElementById('countdownNumber');
    const btnRetry = document.getElementById('btnRetry');
    const btnUnmute = document.getElementById('btnUnmute');
    const menu = document.getElementById('menu');
    const startLayer = document.getElementById('startLayer');
    const btnStart = document.getElementById('btnStart');

    function setupVideoSources(videoElement, webmUrl, mp4Url = "") {
      videoElement.innerHTML = "";
      if (webmUrl) {
        const s = document.createElement('source');
        s.src = webmUrl; s.type = 'video/webm; codecs="vp8,opus"';
        videoElement.appendChild(s);
      }
      if (mp4Url) {
        const s = document.createElement('source');
        s.src = mp4Url; s.type = 'video/mp4';
        videoElement.appendChild(s);
      }
      videoElement.setAttribute('webkit-playsinline','true');
      videoElement.setAttribute('playsinline','true');
      videoElement.preload = 'auto';
      videoElement.load();
    }

    async function showCountdown(seconds = 3) {
      return new Promise((resolve) => {
        countdownOverlay.style.display = 'flex';
        let c = seconds; countdownNumber.textContent = c;
        const t = setInterval(() => {
          c--;
          if (c > 0) {
            countdownNumber.textContent = c;
            countdownNumber.style.animation = 'none';
            setTimeout(() => countdownNumber.style.animation = 'pulse 1s ease-in-out', 10);
          } else {
            countdownNumber.textContent = 'GO!';
            setTimeout(() => { clearInterval(t); countdownOverlay.style.display = 'none'; resolve(); }, 1000);
          }
        }, 1000);
      });
    }

    // =============== AR Engine ===============
    let THREE, ZapparThree, renderer, camera, scene, tracker, anchor, plane;
    let introTexture, exerciseTexture, currentVideo;
    let arInitialized = false;

    // ‚úÖ Permission: –∑”©–≤—Ö”©–Ω Zappar-–∞–∞—Ä
    async function requestCameraAccess() {
      try {
        const permitted = await ZapparThree.permissionRequest();
        if (!permitted) throw new Error('Zappar permission denied');
        camera?.start(true);
        dbg('Camera access granted and started');
        return true;
      } catch (e) {
        dbg('Camera permission failed: ' + e.message);
        throw e;
      }
    }

    function createVideoTexture(videoElement) {
      const tex = new THREE.VideoTexture(videoElement);
      tex.colorSpace = THREE.SRGBColorSpace;
      tex.flipY = false;
      tex.minFilter = THREE.LinearFilter;
      tex.magFilter = THREE.LinearFilter;
      tex.format = THREE.RGBFormat;
      tex.generateMipmaps = false;
      return tex;
    }

    function adjustPlaneToVideo(videoElement) {
      const w = videoElement.videoWidth || 1280;
      const h = videoElement.videoHeight || 720;
      const displayH = 0.8;
      const displayW = displayH * (w / h);
      plane.geometry.dispose();
      plane.geometry = new THREE.PlaneGeometry(displayW, displayH, 32, 32);
      plane.position.set(AR_POSITION.x, AR_POSITION.y, AR_POSITION.z);
      plane.rotation.set(0, 0, 0);
      dbg(`Plane ${displayW.toFixed(2)}√ó${displayH} at z=${AR_POSITION.z}`);
    }

    async function initializeAR() {
  try {
    ({ THREE, ZapparThree } = await window.__depsReady);
    if (!THREE || !ZapparThree) throw new Error('Deps not loaded');
    if (ZapparThree.browserIncompatible()) throw new Error('Browser incompatible');

    renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false, powerPreference:'high-performance', precision:'highp' });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.domElement.classList.add('webgl');
    document.body.appendChild(renderer.domElement);

    window.addEventListener('resize', () => renderer.setSize(window.innerWidth, window.innerHeight));
    ZapparThree.glContextSet(renderer.getContext());

    // ‚¨á‚¨á‚¨á  –≠–ù–≠ –•–≠–°–≠–ì–¢ –ó–ê–°–í–ê–†  ‚¨á‚¨á‚¨á
    // ”®–º–Ω”©—Ö { userFacing:false, rearCameraSource:'best' }-–∏–π–≥ –∞–≤—á —Ö–∞—è–Ω–∞
    camera = new ZapparThree.Camera(); // —Å–æ–Ω–≥–æ–ª—Ç–≥“Ø–π–≥—ç—ç—Ä “Ø“Ø—Å–≥—ç–Ω—ç
    // (—ç–Ω–¥ start —Ö–∏–π—Ö–≥“Ø–π ‚Äî permission –∞–≤—á –±–∞–π—Ö–¥–∞–∞ start(true) –¥—É—É–¥–∞—Ö –±–æ–ª–Ω–æ)
    // ‚¨Ü‚¨Ü‚¨Ü  –ó–ê–°–í–ê–† –î–£–£–°–ê–í  ‚¨Ü‚¨Ü‚¨Ü

    scene = new THREE.Scene();
    scene.background = camera.backgroundTexture;

    tracker = new ZapparThree.InstantWorldTracker();
    anchor = new ZapparThree.InstantWorldAnchorGroup(camera, tracker);
    scene.add(anchor);

    plane = new THREE.Mesh(
      new THREE.PlaneGeometry(1, 1, 16, 16),
      new THREE.MeshBasicMaterial({ transparent:true, side:THREE.DoubleSide, alphaTest:0.1 })
    );
    anchor.add(plane);

    renderer.setAnimationLoop(() => {
      tracker.setAnchorPoseFromCameraOffset(AR_POSITION.x, AR_POSITION.y, AR_POSITION.z);
      camera.updateFrame(renderer);
      renderer.render(scene, camera);
    });

    // –î–∞—Ö–∏–Ω foreground –±–æ–ª–æ—Ö–¥–æ–æ –º”©–Ω rear-–≥ —à–∞–∞—Ä–¥–Ω–∞
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) { try { camera.start(true); } catch(e){} } // ‚Üê true = rear
      else { try { camera.pause(); } catch(e){} }
    });

    arInitialized = true;
    dbg('AR initialized');
  } catch (e) {
    console.error('AR initialization failed:', e);
    dbg('Initialization failed - check console');
    throw e;
  }
}

    async function playVideoWithAudio(videoElement) {
      try {
        if (videoElement.readyState < 2) {
          await new Promise(r => videoElement.addEventListener('canplay', r, { once:true }));
        }
        videoElement.muted = false; await videoElement.play();
        btnUnmute.style.display = 'none';
        dbg('Video playing with audio');
      } catch (e) {
        videoElement.muted = true;
        try { await videoElement.play(); btnUnmute.style.display = 'inline-block'; dbg('Video playing muted - tap Unmute'); }
        catch (err) { dbg('Failed to play video: ' + err.message); }
      }
    }

    function showPermissionError(){ loadingScreen.style.display='none'; countdownOverlay.style.display='none'; permissionError.style.display='flex'; }
    function hideAllScreens(){ loadingScreen.style.display='none'; permissionError.style.display='none'; countdownOverlay.style.display='none'; }

    async function startARExperience() {
      try {
        dbg('Starting AR‚Ä¶');
        loadingScreen.style.display = 'flex';

        await requestCameraAccess();
        setupVideoSources(vIntro, INTRO_WEBM_URL, INTRO_MP4_URL);
        setupVideoSources(vExercise, EXERCISE_WEBM_URL, EXERCISE_MP4_URL);

        introTexture = introTexture || createVideoTexture(vIntro);
        exerciseTexture = exerciseTexture || createVideoTexture(vExercise);

        currentVideo = vIntro;
        plane.material.map = introTexture;

        if (vIntro.readyState >= 1) adjustPlaneToVideo(vIntro);
        else vIntro.addEventListener('loadedmetadata', () => adjustPlaneToVideo(vIntro), { once:true });

        hideAllScreens();
        await showCountdown(3);
        await playVideoWithAudio(vIntro);

        vIntro.onended = () => { menu.style.display = 'flex'; dbg('Intro ended ‚Üí menu'); };
      } catch (e) {
        console.error('Failed to start AR experience:', e);
        dbg('Failed to start - see console');
        showPermissionError();
      }
    }

    // Buttons
    btnRetry.addEventListener('click', async () => { permissionError.style.display='none'; loadingScreen.style.display='flex'; await startARExperience(); });
    btnUnmute.addEventListener('click', async () => { if (currentVideo){ try{ currentVideo.muted=false; await currentVideo.play(); btnUnmute.style.display='none'; dbg('Audio enabled'); }catch(e){ dbg('Enable audio failed: '+e.message);} }});

    document.getElementById('btnExercise').addEventListener('click', async () => {
      try {
        menu.style.display = 'none';
        dbg('Start exercise‚Ä¶');
        try { await requestCameraAccess(); } catch (e) { dbg('Permission needed for exercise'); showPermissionError(); return; }
        if (currentVideo) currentVideo.pause();

        currentVideo = vExercise;
        plane.material.map = exerciseTexture;

        if (vExercise.readyState >= 1) adjustPlaneToVideo(vExercise);
        else vExercise.addEventListener('loadedmetadata', () => adjustPlaneToVideo(vExercise), { once:true });

        await showCountdown(3);
        vExercise.currentTime = 0;
        await playVideoWithAudio(vExercise);
        dbg('Exercise playing');
      } catch (e) { console.error(e); dbg('Exercise failed: '+e.message); }
    });

    document.getElementById('btnRestart').addEventListener('click', async () => {
      try {
        menu.style.display = 'none';
        dbg('Restart intro‚Ä¶');
        if (currentVideo) currentVideo.pause();
        currentVideo = vIntro;
        plane.material.map = introTexture;
        await showCountdown(2);
        vIntro.currentTime = 0;
        await playVideoWithAudio(vIntro);
      } catch (e) { console.error(e); dbg('Restart failed: '+e.message); }
    });

    // START button ‚Üí initialize + start (no auto-start on load)
    btnStart.addEventListener('click', async () => {
      try {
        startLayer.style.display = 'none';
        if (!arInitialized) await initializeAR();
        await startARExperience();
      } catch (e) {
        dbg('Start failed: ' + e.message);
        showPermissionError();
      }
    });

    /* ‚ùå –ê–≤—Ç–æ-—ç—Ö–ª“Ø“Ø–ª—ç—Ö–∏–π–≥ —É–Ω—Ç—Ä–∞–∞—Å–∞–Ω */
    // window.addEventListener('load', async () => { ... });
  </script>
</body>
</html>
